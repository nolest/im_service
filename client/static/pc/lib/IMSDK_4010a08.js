function onConnectionLost(e){"function"==typeof IMSDK.connect_fail&&IMSDK.connect_fail.call(this),0!==e.errorCode,client.connect({onSuccess:onConnect,keepAliveInterval:10})}function onConnect(){client.subscribe(IMSDK.connect_obj.clientId,{qos:1,onSuccess:onSubscribeSuccess})}function onSubscribeSuccess(e){for(var n=[],t=parseSubscribeAck(e),s=0;s<t.length;++s)if(t[s].messages){for(var o=t[s].messages,i=0;i<o.length;++i){var c=JSON.parse(o[i]);n.push(c)}"function"==typeof IMSDK.message_connect_success&&IMSDK.message_connect_success.call(this,n)}}function onMessageArrived(e){var n=JSON.parse(e.payloadString);"function"==typeof IMSDK.message_receive&&IMSDK.message_receive.call(this,n)}var client=null,parseSubscribeAck=function(e){for(var n=0,t=e.grantedQos,s=[];n<t.length;){var o={};if(o.qos=t.subarray(n,n+1)[0],n+=1,n>t.length-4)return void console.error("poco chat protocol fail.");var i=readInt32BE(t,n);n+=4,o.messages=[];for(var c=0;i>c;++c){{readInt32BE(t,n)}n+=4;var a=readInt32BE(t,n);if(n+=4,0!==a){var r=t.subarray(n,n+a);n+=a;var d=new Zlib.Inflate(r).decompress();o.messages.push(arrayToString(d))}}s.push(o)}return s},arrayToString=function(e){var n=String.fromCharCode.apply(null,e);return decodeURIComponent(escape(n))},deleteMessage=function(e,n,t){e.subscribe("$DELDOWN/"+n+":"+t)},readInt32BE=function(e,n){var t=e[n]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3];return t<<=0},IMSDK={subscribe_mode:1,pre_fixed:{buyer:"yuebuyer/",seller:"yueseller/"},options:{keepalive:10,clientId:""},init:function(e){var n=this;n.host=e.hostname||"online-wifi.yueus.com",n.port=e.port||8983,n.options.clientId=e.client_id||"",n.message_connect_success=e.message_connect_success||function(){},n.message_receive=e.message_receive||function(){},n.message_send_success=e.message_send_success||function(){},n.message_send_fail=e.message_send_fail||function(){},n.connect_fail=e.connect_fail||function(){},n.render_send_form()},_connect_valid:function(){var e=this;if(e.options.clientId)return!0;throw"clientId is unvalid"},options_parse:function(e){var n=this,t={};return t.keepalive=e.keepalive,t.clientId=n.pre_fixed.seller+e.clientId.toString(),n.connect_obj=t,t},connect:function(){var e=this;e._connect_valid();var n=e.options_parse(e.options);client=new Paho.MQTT.Client(e.host,e.port,n.clientId),client.onConnectionLost=onConnectionLost,client.onMessageArrived=onMessageArrived,client.connect({onSuccess:onConnect,keepAliveInterval:10})},send_msg:function(e,n){var t=this,s=JSON.stringify(e);t._form.innerHTML='<input id="form_input" type="text" name="data" data-role="submit"/>',document.getElementById("form_input").value=s;var o=new FormData(document.getElementById("ajaxform")),i=new XMLHttpRequest;i.open("POST",n),i.onload=function(){200==i.status&&i.responseText?"function"==typeof t.message_send_success&&t.message_send_success.call(this,e,i):"function"==typeof t.message_send_fail&&t.message_send_fail.call(this,e,i)},i.send(o)},send_media:function(e,n,t,s){var o=this,i=JSON.stringify(e),c=n;c.id="medias",o._media_form.innerHTML='<input id="media_form_input" type="text" name="data"/>',document.getElementById("media_form_input").value=i,document.getElementById("mediaform").appendChild(c),e.preview_src=s;var a=new FormData(document.getElementById("mediaform")),r=new XMLHttpRequest;r.open("POST",t),r.onload=function(){200==r.status&&r.responseText?"function"==typeof o.message_send_success&&o.message_send_success.call(this,e,r.response):"function"==typeof o.message_send_fail&&o.message_send_fail.call(this,e,r.response)},r.send(a)},render_send_form:function(){var e=this;e._form=document.createElement("form"),e._form.setAttribute("id","ajaxform"),e._form.setAttribute("class","fn-hide"),e._media_form=document.createElement("form"),e._media_form.setAttribute("id","mediaform"),e._media_form.setAttribute("class","fn-hide"),document.getElementsByTagName("body")[0].appendChild(e._form),document.getElementsByTagName("body")[0].appendChild(e._media_form)},has_read:function(e){var n=this;for(var t in e)console.log(t),deleteMessage(client,n.connect_obj.clientId,e[t])}};