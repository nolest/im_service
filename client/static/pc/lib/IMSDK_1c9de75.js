function onConnectionLost(e){console.log(e),"function"==typeof IMSDK.connect_fail&&IMSDK.connect_fail.call(this),0!==e.errorCode,client.connect({onSuccess:onConnect,keepAliveInterval:10})}function onConnect(){client.subscribe(IMSDK.connect_obj.clientId,{qos:1,onSuccess:onSubscribeSuccess})}function onSubscribeSuccess(e){for(var n=[],s=parseSubscribeAck(e),t=0;t<s.length;++t)if(s[t].messages){for(var o=s[t].messages,i=0;i<o.length;++i){var r=JSON.parse(o[i]);n.push(r)}"function"==typeof IMSDK.message_connect_success&&IMSDK.message_connect_success.call(this,n)}}function onMessageArrived(e){var n=JSON.parse(e.payloadString);"function"==typeof IMSDK.message_receive&&IMSDK.message_receive.call(this,n)}var client=null,parseSubscribeAck=function(e){for(var n=0,s=e.grantedQos,t=[];n<s.length;){var o={};if(o.qos=s.subarray(n,n+1)[0],n+=1,n>s.length-4)return void console.error("poco chat protocol fail.");var i=readInt32BE(s,n);n+=4,o.messages=[];for(var r=0;i>r;++r){{readInt32BE(s,n)}n+=4;var c=readInt32BE(s,n);if(n+=4,0!==c){var a=s.subarray(n,n+c);n+=c;var l=new Zlib.Inflate(a).decompress();o.messages.push(arrayToString(l))}}t.push(o)}return t},arrayToString=function(e){var n=String.fromCharCode.apply(null,e);return decodeURIComponent(escape(n))},deleteMessage=function(e,n,s){e.subscribe("$DELDOWN/"+n+":"+s)},readInt32BE=function(e,n){var s=e[n]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3];return s<<=0},IMSDK={subscribe_mode:1,pre_fixed:{buyer:"yuebuyer/",seller:"yueseller/"},options:{keepalive:10,clientId:""},init:function(e){var n=this;n.host=e.hostname||"online-wifi.yueus.com",n.port=e.port||8983,n.options.clientId=e.client_id||"",n.subscribe_role=e.subscribe_role||"seller",n.message_connect_success=e.message_connect_success||function(){},n.message_receive=e.message_receive||function(){},n.message_send_success=e.message_send_success||function(){},n.message_send_fail=e.message_send_fail||function(){},n.connect_fail=e.connect_fail||function(){},n.render_send_form()},_connect_valid:function(){var e=this;if(e.options.clientId)return!0;throw"clientId is unvalid"},options_parse:function(e){var n=this,s={};return s.keepalive=e.keepalive,s.clientId="seller"==n.subscribe_role?n.pre_fixed.seller+e.clientId.toString():n.pre_fixed.buyer+e.clientId.toString(),n.connect_obj=s,s},connect:function(){var e=this;e._connect_valid();var n=e.options_parse(e.options);client=new Paho.MQTT.Client(e.host,e.port,n.clientId),client.onConnectionLost=onConnectionLost,client.onMessageArrived=onMessageArrived,client.connect({onSuccess:onConnect,keepAliveInterval:10})},send_msg:function(e,n){var s=this,t=JSON.stringify(e);s._form.innerHTML='<input id="form_input" type="text" name="data" data-role="submit"/>',document.getElementById("form_input").value=t;var o=new FormData(document.getElementById("ajaxform")),i=new XMLHttpRequest;i.open("POST",n),i.onload=function(){200==i.status&&i.responseText?"function"==typeof s.message_send_success&&s.message_send_success.call(this,e,i):"function"==typeof s.message_send_fail&&s.message_send_fail.call(this,e,i)},i.send(o)},send_media:function(e,n,s,t){var o=this,i=JSON.stringify(e),r=n;r.id="medias",o._media_form.innerHTML='<input id="media_form_input" type="text" name="data"/>',document.getElementById("media_form_input").value=i,document.getElementById("mediaform").appendChild(r),e.preview_src=t;var c=new FormData(document.getElementById("mediaform")),a=new XMLHttpRequest;a.open("POST",s),a.onload=function(){200==a.status&&a.responseText?"function"==typeof o.message_send_success&&o.message_send_success.call(this,e,a.response):"function"==typeof o.message_send_fail&&o.message_send_fail.call(this,e,a.response)},a.send(c)},render_send_form:function(){var e=this;e._form=document.createElement("form"),e._form.setAttribute("id","ajaxform"),e._form.setAttribute("class","fn-hide"),e._media_form=document.createElement("form"),e._media_form.setAttribute("id","mediaform"),e._media_form.setAttribute("class","fn-hide"),document.getElementsByTagName("body")[0].appendChild(e._form),document.getElementsByTagName("body")[0].appendChild(e._media_form)},has_read:function(e){var n=this;for(var s in e)console.log(s),deleteMessage(client,n.connect_obj.clientId,e[s])}};